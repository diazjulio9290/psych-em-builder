<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Psych E and M Note Builder Mockup</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --good: #2ee59d;
      --warn: #ffd166;
      --bad: #ff5c7a;
      --accent: #77a7ff;
      --accent2: #b68cff;
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    html[data-theme="light"]{
      /* Base */
      --bg: #f6f7fb;
      --text: rgba(10, 18, 34, 0.92);
      --muted: rgba(10, 18, 34, 0.62);
      --muted2: rgba(10, 18, 34, 0.50);

      /* Surfaces and borders */
      --panel: rgba(255,255,255,0.92);
      --panel2: rgba(255,255,255,0.70);
      --border: rgba(16, 24, 40, 0.14);

      /* Accents */
      --accent: #2f6fec;
      --accent2: #6d5efc;
      --good: #12b981;
      --warn: #f59e0b;
      --bad:  #ef4444;

      /* Shadow */
      --shadow: 0 18px 55px rgba(16, 24, 40, 0.10);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(119,167,255,0.18), transparent 55%),
                  radial-gradient(900px 700px at 85% 35%, rgba(182,140,255,0.16), transparent 55%),
                  radial-gradient(700px 500px at 30% 95%, rgba(46,229,157,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
    }
    html[data-theme="light"] body{
      background:
        radial-gradient(1200px 800px at 18% 10%, rgba(47,111,236,0.10), transparent 58%),
        radial-gradient(900px 700px at 85% 35%, rgba(109,94,252,0.10), transparent 58%),
        radial-gradient(700px 500px at 35% 95%, rgba(18,185,129,0.07), transparent 58%),
        var(--bg);
    }
    /* Make top surfaces actually white in light mode */
    html[data-theme="light"] .topbar,
    html[data-theme="light"] .card{
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border-color: rgba(16, 24, 40, 0.12);
    }
    /* Logo should match the lighter theme, less neon */
    html[data-theme="light"] .logo{
      background: linear-gradient(135deg, rgba(47,111,236,0.95), rgba(109,94,252,0.92));
      box-shadow: 0 12px 30px rgba(47,111,236,0.18);
    }
    /* Buttons should have clearer edges */
    html[data-theme="light"] .btn{
      background: rgba(255,255,255,0.88);
      border-color: rgba(16, 24, 40, 0.14);
    }
    html[data-theme="light"] .btn:hover{
      background: rgba(255,255,255,0.98);
    }
    a{ color: var(--accent); text-decoration:none; }
    .shell{ max-width: 1180px; margin: 0 auto; padding: 26px 18px 40px; }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding: 16px 18px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(119,167,255,0.9), rgba(182,140,255,0.85));
      box-shadow: 0 12px 35px rgba(119,167,255,0.22);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-20%;
      background: radial-gradient(circle at 35% 25%, rgba(255,255,255,0.55), transparent 45%);
      transform: rotate(15deg);
    }
    .brand h1{ margin:0; font-size: 16px; letter-spacing:0.2px; }
    .brand p{ margin:0; font-size: 12px; color: var(--muted); }
    .right{
      display:flex; gap:10px; align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .dot{
      width:9px; height:9px; border-radius: 999px;
      background: var(--good);
      box-shadow: 0 0 0 3px rgba(46,229,157,0.15);
    }
    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-size: 13px;
      cursor:pointer;
      transition: transform 0.06s ease, background 0.15s ease, border 0.15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.09); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(119,167,255,0.85), rgba(182,140,255,0.80));
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 14px 40px rgba(119,167,255,0.20);
    }
    .btn.primary:hover{ filter: brightness(1.03); }
    .grid{
      margin-top: 18px;
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    html[data-theme="light"] .cardHeader{
      background: rgba(255,255,255,0.92);
      border-bottom-color: rgba(16,24,40,0.10);
    }
    .cardHeader h2{
      margin:0; font-size: 14px;
      letter-spacing: 0.2px;
    }
    .sub{ margin:0; font-size: 12px; color: var(--muted); }
    .section{
      padding: 14px 16px 16px;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-size: 13px;
      cursor:pointer;
      transition: background 0.15s ease, border 0.15s ease;
      user-select:none;
    }
    .tab.active{
      background: rgba(119,167,255,0.22);
      border: 1px solid rgba(119,167,255,0.35);
      color: var(--text);
    }
    .condGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }
    @media (max-width: 780px){
      .condGrid{ grid-template-columns: 1fr; }
    }
    /* Tabs: stronger neutral background so they are visible */
    html[data-theme="light"] .tab{
      background: rgba(16, 24, 40, 0.04);
      border-color: rgba(16, 24, 40, 0.14);
      color: rgba(10,18,34,0.78);
    }
    html[data-theme="light"] .tab:hover{
      background: rgba(47,111,236,0.08);
      border-color: rgba(47,111,236,0.22);
    }
    /* Active tab: solid fill + subtle shadow */
    html[data-theme="light"] .tab.active{
      background: rgba(47,111,236,0.14);
      border-color: rgba(47,111,236,0.35);
      color: rgba(10,18,34,0.92);
      box-shadow: 0 10px 24px rgba(47,111,236,0.10);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    @media (max-width: 780px){
      .row{ grid-template-columns: 1fr; }
    }
    .field{
      display:flex; flex-direction:column; gap:8px;
      padding: 12px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
    }
    /* Section fields and groups should read as cards */
    html[data-theme="light"] .field,
    html[data-theme="light"] .group,
    html[data-theme="light"] .scoreCard{
      background: rgba(255,255,255,0.92);
      border-color: rgba(16,24,40,0.12);
    }
    .label{
      font-size: 12px;
      color: var(--muted);
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
    }
    select, input[type="number"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline:none;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance: none; margin: 0;
    }

    .groups{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 780px){
      .groups{ grid-template-columns: 1fr; }
    }
    .group{
      padding: 12px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
    }
    /* Inputs: in light mode, dark inputs look odd. Make them white. */
    html[data-theme="light"] select,
    html[data-theme="light"] input[type="number"]{
      background: rgba(255,255,255,0.98);
      border-color: rgba(16,24,40,0.16);
      color: rgba(10,18,34,0.92);
    }
    .group h3{ margin:0 0 8px 0; font-size: 13px; }
    .check{
      display:flex; align-items:flex-start; gap:10px;
      padding: 8px 8px;
      border-radius: 12px;
      transition: background 0.15s ease;
    }
    .check:hover{ background: rgba(255,255,255,0.04); }
    html[data-theme="light"] .check:hover{
      background: rgba(47,111,236,0.06);
    }
    .check input{ margin-top: 2px; }
    .check .txt{ font-size: 13px; color: var(--text); }
    .check .hint{ font-size: 12px; color: var(--muted2); margin-top: 2px; }

    .banner{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255, 209, 102, 0.10);
      color: rgba(255,255,255,0.86);
      display:flex; align-items:flex-start; gap:10px;
      font-size: 12px;
      line-height: 1.4;
    }
    .banner strong{ color: rgba(255,255,255,0.95); }
    .ico{
      width: 20px; height: 20px;
      border-radius: 8px;
      background: rgba(255, 209, 102, 0.22);
      border: 1px solid rgba(255, 209, 102, 0.35);
      display:flex; align-items:center; justify-content:center;
      font-weight: 700;
      flex: 0 0 auto;
    }
    html[data-theme="light"] .banner{
      border: 1px solid rgba(255, 193, 7, 0.35);
      background: rgba(255, 193, 7, 0.16);
      color: rgba(33, 24, 6, 0.95);
      box-shadow: 0 10px 24px rgba(255, 193, 7, 0.12);
    }
    html[data-theme="light"] .banner strong{ color: rgba(33, 24, 6, 0.98); }
    html[data-theme="light"] .ico{
      background: rgba(255, 193, 7, 0.32);
      border-color: rgba(255, 193, 7, 0.50);
      color: rgba(33, 24, 6, 0.95);
    }

    .status{
      display:flex; flex-direction:column; gap:10px;
    }
    .scoreCard{
      padding: 14px 14px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      display:flex; flex-direction:column; gap:10px;
    }
    /* Pills and badges should not look washed out */
    html[data-theme="light"] .pill{
      background: rgba(255,255,255,0.92);
      border-color: rgba(16,24,40,0.14);
      color: rgba(10,18,34,0.70);
    }
    /* Make badge colors readable on light backgrounds */
    html[data-theme="light"] .badge{
      background: rgba(16,24,40,0.04);
      border-color: rgba(16,24,40,0.14);
      color: rgba(10,18,34,0.70);
    }
    .big{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap: 12px;
    }
    .code{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.3px;
    }
    .badge{
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      user-select:none;
    }
    .badge.good{ border-color: rgba(46,229,157,0.35); background: rgba(46,229,157,0.12); color: rgba(255,255,255,0.92); }
    .badge.warn{ border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.12); color: rgba(255,255,255,0.92); }
    .badge.bad{ border-color: rgba(255,92,122,0.40); background: rgba(255,92,122,0.12); color: rgba(255,255,255,0.92); }
    .reason{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }

    .noteBox{
      margin-top: 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      overflow:hidden;
    }
    .noteTop{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    pre{
      margin:0;
      padding: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.45;
      color: rgba(255,255,255,0.88);
    }
    html[data-theme="light"] .noteBox{
      border-color: rgba(9,14,25,0.16);
      background: #f3f6fb;
    }
    html[data-theme="light"] .noteTop{
      border-bottom-color: rgba(9,14,25,0.16);
      color: rgba(9,14,25,0.72);
      background: #ffffff;
    }
    html[data-theme="light"] pre{
      color: rgba(9,14,25,0.92);
    }

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,0.9);
      font-size: 13px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity 0.2s ease;
      backdrop-filter: blur(10px);
      max-width: 92vw;
    }
    .toast.show{ opacity: 1; }

    html[data-theme="light"] .badge.good{
      background: rgba(18,185,129,0.14);
      border-color: rgba(18,185,129,0.30);
      color: rgba(10,18,34,0.92);
    }
    html[data-theme="light"] .badge.warn{
      background: rgba(245,158,11,0.16);
      border-color: rgba(245,158,11,0.32);
      color: rgba(10,18,34,0.92);
    }
    html[data-theme="light"] .badge.bad{
      background: rgba(239,68,68,0.14);
      border-color: rgba(239,68,68,0.30);
      color: rgba(10,18,34,0.92);
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Psych E and M Note Builder</h1>
          <p class="sub">Structured checklist plus suggested 99213 or 99214. No patient identifiers.</p>
        </div>
      </div>
      <div class="right">
        <div class="pill" title="Prototype mode">
          <span class="dot"></span>
          Prototype, local only
        </div>
        <button class="btn" id="btnTheme" title="Toggle light or dark theme">Light mode</button>
        <button class="btn" id="btnClearPatient" title="Clear patient info">Clear patient info</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Templates</h2>
            <p class="sub">Pick a common scenario. It pre fills sensible defaults.</p>
          </div>
          <div class="tabs" role="tablist" aria-label="Diagnosis tabs">
            <button class="tab active" data-template="adhd" role="tab" aria-selected="true">ADHD follow up</button>
            <button class="tab" data-template="anxiety" role="tab" aria-selected="false">Anxiety follow up</button>
            <button class="tab" data-template="depression" role="tab" aria-selected="false">Depression follow up</button>
            <button class="tab" data-template="combo" role="tab" aria-selected="false">Anxiety plus ADHD</button>
          </div>
        </div>

        <div class="section">
          <div class="row">
            <div class="field">
              <div class="label">
                <span>Visit type</span>
                <span class="sub">For note wording</span>
              </div>
              <select id="visitType">
                <option value="">Select visit type</option>
                <option value="In person">In person</option>
                <option value="Telehealth video">Telehealth video</option>
                <option value="Telehealth phone">Telehealth phone</option>
              </select>
            </div>

            <div class="field">
              <div class="label">
                <span>Total time (minutes)</span>
                <span class="sub">Optional, time based coding</span>
              </div>
              <input id="timeMinutes" type="number" min="0" max="240" value="0" />
            </div>
          </div>

          <div class="field" id="timeBreakdownBox" style="display:none; margin-top:12px;">
            <div class="label">
              <span>Time breakdown (audit support)</span>
              <span class="sub">Choose minutes in 5 minute steps. Must total to Total time.</span>
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="field">
                <div class="label"><span>Preparing to see the patient</span><span class="sub">minutes</span></div>
                <select id="tPrep"></select>
                <div class="sub">Review of prior records, tests, rating scales.</div>
              </div>

              <div class="field">
                <div class="label"><span>Exam and evaluation plus counseling and education</span><span class="sub">minutes</span></div>
                <select id="tEvalCounsel"></select>
                <div class="sub">Face to face evaluation, treatment plan, medication education, side effects.</div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="label"><span>Ordering meds, tests, procedures</span><span class="sub">minutes</span></div>
                <select id="tOrders"></select>
              </div>

              <div class="field">
                <div class="label"><span>Documentation in the EHR</span><span class="sub">minutes</span></div>
                <select id="tDoc"></select>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="label"><span>Care coordination and communication</span><span class="sub">minutes</span></div>
                <select id="tCoord"></select>
                <div class="sub">When not separately reported.</div>
              </div>

              <div class="field">
                <div class="label"><span>Breakdown total</span><span class="sub" id="tStatus">0 / 0</span></div>
                <div class="sub" id="tWarn"></div>
              </div>
            </div>
          </div>

          <div class="groups">
            <div class="group">
              <h3>Problems addressed</h3>

              <div class="sub" style="margin-bottom:8px;">
                Select conditions addressed today. Do not add patient identifiers.
              </div>

              <div class="condGrid">
                <label class="check"><input type="checkbox" class="cond" value="ADHD"><div class="txt">ADHD</div></label>
                <label class="check"><input type="checkbox" class="cond" value="Anxiety"><div class="txt">Anxiety</div></label>
                <label class="check"><input type="checkbox" class="cond" value="Depression"><div class="txt">Depression</div></label>
                <label class="check"><input type="checkbox" class="cond" value="PTSD"><div class="txt">PTSD</div></label>
                <label class="check"><input type="checkbox" class="cond" value="OCD"><div class="txt">OCD</div></label>
                <label class="check"><input type="checkbox" class="cond" value="Insomnia"><div class="txt">Insomnia</div></label>
                <label class="check"><input type="checkbox" class="cond" value="ASD"><div class="txt">Autism (ASD)</div></label>
                <label class="check"><input type="checkbox" class="cond" value="SUD"><div class="txt">Substance use</div></label>
              </div>

              <label class="check" style="margin-top:6px;">
                <input type="checkbox" id="probWorsening"/>
                <div>
                  <div class="txt">Any condition worsening or exacerbated today</div>
                  <div class="hint">This pushes Problems toward Moderate when clinically supported.</div>
                </div>
              </label>

              <div class="sub" id="problemSummary" style="margin-top:8px;"></div>
            </div>

            <div class="group">
              <h3>Data reviewed</h3>

              <label class="check">
                <input type="checkbox" id="d1"/>
                <div>
                  <div class="txt">Rating scales reviewed</div>
                  <div class="hint">PHQ 9, GAD 7, Vanderbilt, ASRS, etc.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="d2"/>
                <div>
                  <div class="txt">Collateral obtained from caregiver</div>
                  <div class="hint">Independent historian can support data element.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="d3"/>
                <div>
                  <div class="txt">Outside records reviewed</div>
                  <div class="hint">Prior eval, school report, therapist note, PCP note.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="d4"/>
                <div>
                  <div class="txt">Labs reviewed or ordered</div>
                  <div class="hint">Only if clinically appropriate.</div>
                </div>
              </label>
            </div>

            <div class="group">
              <h3>Risk and management</h3>

              <label class="check">
                <input type="checkbox" id="r1"/>
                <div>
                  <div class="txt">Prescription drug management today</div>
                  <div class="hint">Start, stop, dose change, monitoring plan, controlled meds.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="r2"/>
                <div>
                  <div class="txt">Safety risk assessed with plan</div>
                  <div class="hint">SI or HI assessment, safety plan, escalation guidance.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="r3"/>
                <div>
                  <div class="txt">Medication side effects reviewed</div>
                  <div class="hint">Sleep, appetite, GI, headaches, activation, sedation.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="r4"/>
                <div>
                  <div class="txt">Controlled substance monitoring discussed</div>
                  <div class="hint">If applicable to local policy.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="r5"/>
                <div>
                  <div class="txt">High risk management decision today</div>
                  <div class="hint">Examples: decision re hospitalization, intensive drug toxicity monitoring, severe exacerbation with significant risk.</div>
                </div>
              </label>
            </div>

            <div class="group">
              <h3>Exam and MSE essentials</h3>

              <label class="check">
                <input type="checkbox" id="m1"/>
                <div>
                  <div class="txt">MSE documented</div>
                  <div class="hint">Appearance, behavior, mood, affect, thought, insight, judgment.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="m2"/>
                <div>
                  <div class="txt">Functional status addressed</div>
                  <div class="hint">School, home, relationships, sleep routine.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="m3"/>
                <div>
                  <div class="txt">Substance use screening documented</div>
                  <div class="hint">As appropriate for age and setting.</div>
                </div>
              </label>

              <label class="check">
                <input type="checkbox" id="m4"/>
                <div>
                  <div class="txt">Plan includes follow up interval</div>
                  <div class="hint">Return window and earlier follow up instructions.</div>
                </div>
              </label>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px;">
            <button class="btn" id="btnSuggestLow" title="Set minimal low complexity defaults">Low complexity set</button>
            <button class="btn" id="btnSuggestMod" title="Set typical moderate complexity defaults">Moderate complexity set</button>
            <button class="btn" id="btnToggleTime" title="Use time instead of MDM when time is entered">Use time when available</button>
          </div>
          <p class="sub" style="margin-top:10px;">
            The suggestion logic is intentionally conservative and simplified for a prototype. Final coding depends on clinician judgment and payer rules.
          </p>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Suggested level and note output</h2>
            <p class="sub">Instant feedback. Copy and paste into the EHR.</p>
          </div>
        </div>

        <div class="section status">
          <div class="scoreCard">
            <div class="big">
              <div>
                <div class="sub">Suggested code</div>
                <div class="code" id="suggestedCode">99213</div>
              </div>
              <div class="badge warn" id="badge">Based on MDM</div>
            </div>
            <div class="reason" id="reasonText">
              Select checklist items to strengthen support for low or moderate MDM. Add time if you prefer time based coding.
            </div>
          </div>

          <div class="noteBox">
            <div class="noteTop">
              <div>Generated note preview</div>
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="previewMeta">Template: ADHD follow up</div>
                <button class="btn" id="btnCopyPreview" title="Copy note">Copy</button>
              </div>
            </div>
            <pre id="notePreview"></pre>
          </div>

          <div class="scoreCard">
            <div class="sub" style="margin-bottom:6px;">What this prototype is doing</div>
            <div class="reason">
              It maps selected items to a simplified MDM signal. Problems, data, and risk contribute. Prescription management and two problems usually push toward 99214.
              If you turn on time mode and enter 30 to 39 minutes, it will prefer 99214.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const els = {
      tabs: Array.from(document.querySelectorAll(".tab")),
      visitType: document.getElementById("visitType"),
      timeMinutes: document.getElementById("timeMinutes"),
      suggestedCode: document.getElementById("suggestedCode"),
      badge: document.getElementById("badge"),
      reasonText: document.getElementById("reasonText"),
      notePreview: document.getElementById("notePreview"),
      previewMeta: document.getElementById("previewMeta"),
      btnCopyPreview: document.getElementById("btnCopyPreview"),
      btnTheme: document.getElementById("btnTheme"),
      btnClearPatient: document.getElementById("btnClearPatient"),
      btnSuggestLow: document.getElementById("btnSuggestLow"),
      btnSuggestMod: document.getElementById("btnSuggestMod"),
      btnToggleTime: document.getElementById("btnToggleTime"),
      timeBreakdownBox: document.getElementById("timeBreakdownBox"),
      tPrep: document.getElementById("tPrep"),
      tEvalCounsel: document.getElementById("tEvalCounsel"),
      tOrders: document.getElementById("tOrders"),
      tDoc: document.getElementById("tDoc"),
      tCoord: document.getElementById("tCoord"),
      tStatus: document.getElementById("tStatus"),
      tWarn: document.getElementById("tWarn"),
      toast: document.getElementById("toast")
    };

    const checks = [
      "d1","d2","d3","d4",
      "r1","r2","r3","r4","r5",
      "m1","m2","m3","m4"
    ].reduce((acc,id)=>{
      acc[id] = document.getElementById(id);
      return acc;
    }, {});

    const conditionChecks = Array.from(document.querySelectorAll(".cond"));
    const probWorsening = document.getElementById("probWorsening");
    const problemSummary = document.getElementById("problemSummary");

    let currentTemplate = "adhd";
    let useTimeWhenAvailable = false;

    const templates = {
      adhd: {
        name: "ADHD follow up",
        defaults: ["r3","m1","m2","m4"],
        dx: ["ADHD"],
        symptomLine: "Attention and executive function symptoms reviewed. Functioning in school and home discussed."
      },
      anxiety: {
        name: "Anxiety follow up",
        defaults: ["r3","m1","m2","m4"],
        dx: ["Generalized anxiety"],
        symptomLine: "Anxiety severity and triggers reviewed. Sleep and somatic symptoms discussed."
      },
      depression: {
        name: "Depression follow up",
        defaults: ["r3","m1","m2","m4"],
        dx: ["Depressive disorder"],
        symptomLine: "Mood, anhedonia, energy, appetite and sleep reviewed. Safety screening completed."
      },
      combo: {
        name: "Anxiety plus ADHD",
        defaults: ["d1","r1","r3","m1","m2","m4"],
        dx: ["ADHD","Generalized anxiety"],
        symptomLine: "Combined symptom review completed. Attention, anxiety, sleep, and functional impact discussed."
      }
    };

    function setConditions(values){
      conditionChecks.forEach(c => c.checked = values.includes(c.value));
      if(probWorsening) probWorsening.checked = false;
    }

    function setTemplate(key){
      currentTemplate = key;
      els.tabs.forEach(t=>{
        const active = t.dataset.template === key;
        t.classList.toggle("active", active);
        t.setAttribute("aria-selected", active ? "true" : "false");
      });

      clearAllChecks();
      if(key === "adhd") setConditions(["ADHD"]);
      if(key === "anxiety") setConditions(["Anxiety"]);
      if(key === "depression") setConditions(["Depression"]);
      if(key === "combo") setConditions(["ADHD","Anxiety"]);
      templates[key].defaults.forEach(id => { checks[id].checked = true; });

      els.previewMeta.textContent = "Template: " + templates[key].name;
      render();
    }

    function clearAllChecks(){
      Object.values(checks).forEach(c => c.checked = false);
      conditionChecks.forEach(c => c.checked = false);
      if(probWorsening) probWorsening.checked = false;
    }

    function setLowDefaults(){
      clearAllChecks();
      setConditions(["ADHD"]);
      ["m1","m2","m4"].forEach(id => checks[id].checked = true);
      render();
      toast("Low complexity set applied.");
    }

    function setModerateDefaults(){
      clearAllChecks();
      setConditions(["ADHD","Anxiety"]);
      ["d1","r1","r2","r3","m1","m2","m4"].forEach(id => checks[id].checked = true);
      render();
      toast("Moderate complexity set applied.");
    }

    function levelRank(lvl){
      return ({ minimal: 0, low: 1, moderate: 2, high: 3 })[lvl] ?? 0;
    }

    function scoreProblems(){
      const count = conditionChecks.filter(c => c.checked).length;
      const worsening = probWorsening.checked;

      const selected = conditionChecks.filter(c => c.checked).map(c => c.value);
      if(problemSummary){
        if(selected.length){
          problemSummary.textContent =
            "Selected: " + selected.join(", ") + (worsening ? " | Worsening: yes" : " | Worsening: no");
        } else {
          problemSummary.textContent = "No conditions selected yet.";
        }
      }

      if(worsening) return "moderate";
      if(count >= 2) return "moderate";
      if(count === 1) return "low";
      return "minimal";
    }

    function scoreData(){
      const testsOrRecords = ["d3","d4"].filter(id => checks[id].checked).length;
      const ratingScales = checks.d1.checked;
      const independentHistorian = checks.d2.checked;

      if(independentHistorian) return "moderate";
      if((ratingScales && testsOrRecords >= 1) || testsOrRecords >= 2) return "moderate";
      if(testsOrRecords >= 1) return "low";
      return "minimal";
    }

    function scoreRisk(){
      if(checks.r5 && checks.r5.checked) return "high";
      if(checks.r1.checked || checks.r2.checked || checks.r4.checked) return "moderate";
      if(checks.r3.checked) return "low";
      return "minimal";
    }

    function mdmFrom2of3(problemLvl, dataLvl, riskLvl){
      const levels = [problemLvl, dataLvl, riskLvl];
      const countAtLeast = (lvl) => levels.filter(x => levelRank(x) >= levelRank(lvl)).length;

      if(countAtLeast("high") >= 2) return "high";
      if(countAtLeast("moderate") >= 2) return "moderate";
      if(countAtLeast("low") >= 2) return "low";
      return "minimal";
    }

    function scoreMDM(){
      const problems = scoreProblems();
      const data = scoreData();
      const risk = scoreRisk();
      const mdm = mdmFrom2of3(problems, data, risk);

      const problemJust =
        problems === "moderate"
          ? "Problems: Moderate (2+ stable conditions or worsening condition addressed)."
          : problems === "low"
            ? "Problems: Low (1 stable chronic condition addressed)."
            : "Problems: Minimal (problem complexity not specified).";

      const dataJust = (() => {
        const parts = [];
        if(checks.d1.checked) parts.push("rating scales");
        if(checks.d2.checked) parts.push("caregiver collateral (independent historian)");
        if(checks.d3.checked) parts.push("outside records");
        if(checks.d4.checked) parts.push("labs reviewed/ordered");
        if(parts.length === 0) return "Data: Minimal (no data documented).";
        const lvlWord = data === "moderate" ? "Moderate" : "Low";
        return `Data: ${lvlWord} (${parts.join(", ")}).`;
      })();

      const riskJust = (() => {
        if(risk === "moderate"){
          const parts = [];
          if(checks.r1.checked) parts.push("prescription drug management");
          if(checks.r2.checked) parts.push("safety risk assessment with plan");
          if(checks.r4.checked) parts.push("controlled substance monitoring");
          return `Risk: Moderate (${parts.join(", ")}).`;
        }
        if(risk === "low") return "Risk: Low (side effects reviewed, no higher risk management documented).";
        return "Risk: Minimal (risk management not specified).";
      })();

      return {
        problems,
        data,
        risk,
        mdm,
        justification: `${problemJust} ${dataJust} ${riskJust}`
      };
    }

    function scoreTime(){
      const mins = Number(els.timeMinutes.value || 0);

      if(mins < 10) return null;
      if(mins <= 19) return { code: "99212", label: "Time 10–19 minutes", mins };
      if(mins <= 29) return { code: "99213", label: "Time 20–29 minutes", mins };
      if(mins <= 39) return { code: "99214", label: "Time 30–39 minutes", mins };
      if(mins <= 54) return { code: "99215", label: "Time 40–54 minutes", mins };

      const units = Math.floor((mins - 54) / 15);
      const suffix = units > 0 ? ` + 99417 x${units}` : "";
      return {
        code: `99215${suffix}`,
        label: `Time 55+ minutes (Prolonged: 99417 x${units})`,
        mins,
        prolongedUnits: units
      };
    }

    function fill5MinuteDropdown(sel){
      if(!sel) return;
      sel.innerHTML = "";
      for(let m = 0; m <= 240; m += 5){
        const opt = document.createElement("option");
        opt.value = String(m);
        opt.textContent = String(m);
        sel.appendChild(opt);
      }
      sel.value = "0";
    }

    function initTimeBreakdowns(){
      fill5MinuteDropdown(els.tPrep);
      fill5MinuteDropdown(els.tEvalCounsel);
      fill5MinuteDropdown(els.tOrders);
      fill5MinuteDropdown(els.tDoc);
      fill5MinuteDropdown(els.tCoord);
    }

    function timeModeOn(){
      return useTimeWhenAvailable && !!scoreTime();
    }

    function getBreakdown(){
      const prep = Number(els.tPrep?.value || 0);
      const evalCounsel = Number(els.tEvalCounsel?.value || 0);
      const orders = Number(els.tOrders?.value || 0);
      const doc = Number(els.tDoc?.value || 0);
      const coord = Number(els.tCoord?.value || 0);
      const total = prep + evalCounsel + orders + doc + coord;
      return { prep, evalCounsel, orders, doc, coord, total };
    }

    function renderBreakdownStatus(){
      if(!els.timeBreakdownBox) return;
      els.timeBreakdownBox.style.display = timeModeOn() ? "block" : "none";

      const mins = Number(els.timeMinutes.value || 0);
      const b = getBreakdown();
      if(els.tStatus) els.tStatus.textContent = `${b.total} / ${mins}`;

      if(els.tWarn){
        if(!timeModeOn()){
          els.tWarn.textContent = "";
        } else if(b.total === mins && mins > 0){
          els.tWarn.textContent = "Breakdown matches total time.";
        } else {
          els.tWarn.textContent = "Breakdown does not match total time. Adjust dropdowns so it equals Total time.";
        }
      }
    }

    function addLine(lines, text){
      const t = (text || "").trim();
      if(t) lines.push(t);
    }

    function joinSentences(arr){
      return arr.filter(Boolean).join(" ");
    }

    function buildNote(signals, chosen){
      const t = templates[currentTemplate];
      const visitType = els.visitType.value;

      const lines = [];
      addLine(lines, "PSYCHIATRY E AND M MEDICATION MANAGEMENT NOTE (Established Patient)");
      addLine(lines, "Visit type: " + visitType);
      addLine(lines, "Diagnoses: " + t.dx.join(", "));
      addLine(lines, "");

      addLine(lines, "Interval history: " + t.symptomLine);
      addLine(lines, "");

      if(checks.r2.checked){
        addLine(lines, "Safety: Suicide and harm risk assessment completed. Safety plan and escalation guidance reviewed.");
      }

      if(checks.m1.checked){
        addLine(lines, "MSE: Appearance and behavior appropriate. Speech normal. Thought process linear. Insight and judgment fair to good.");
      }

      if(checks.m2.checked){
        addLine(lines, "Function: School, home routine, relationships, and sleep routine reviewed. Functional impact discussed.");
      }

      if(checks.m3.checked){
        addLine(lines, "Substance: Screening documented as age and setting appropriate.");
      }

      const dataSentences = [];
      if(checks.d1.checked) dataSentences.push("Rating scales reviewed (for example PHQ 9, GAD 7, Vanderbilt, ASRS as applicable).");
      if(checks.d2.checked) dataSentences.push("Collateral obtained from caregiver as an independent historian.");
      if(checks.d3.checked) dataSentences.push("Outside records reviewed (for example prior evaluation, school report, therapist note, or PCP note as applicable).");
      if(checks.d4.checked) dataSentences.push("Labs reviewed or ordered as clinically appropriate.");

      if(dataSentences.length){
        addLine(lines, "Data: " + joinSentences(dataSentences));
      }

      if(checks.r1.checked){
        addLine(lines, "Medications: Prescription drug management performed today. Risks, benefits, alternatives, and monitoring plan reviewed.");
      } else if(checks.r3.checked){
        addLine(lines, "Medications: Current regimen reviewed. Side effects reviewed and monitoring guidance discussed.");
      }

      if(checks.r4.checked){
        addLine(lines, "Controlled substances: Monitoring and policy requirements discussed as applicable (for example PDMP review, refill expectations, safe storage).");
      }

      const planSentences = [];
      planSentences.push("Plan: Continue treatment plan with shared decision making.");
      if(checks.m4.checked){
        planSentences.push("Follow up interval set and return precautions reviewed.");
      }
      addLine(lines, "");
      addLine(lines, joinSentences(planSentences));
      addLine(lines, "");

      if(chosen.basis === "time"){
        const mins = chosen.timeMinutes;
        const b = getBreakdown();

        addLine(lines, `MDM and coding summary: Time based selection used. Total time on date of service: ${mins} minutes.`);

        if(b.total === mins && mins > 0){
          addLine(lines, "");
          addLine(lines, "This level of service is based on total time spent by the provider on the calendar day of the encounter.");
          addLine(lines, "");
          if(b.prep) addLine(lines, `* ${b.prep} minutes: Preparing to see the patient, including review of prior records and tests.`);
          if(b.evalCounsel) addLine(lines, `* ${b.evalCounsel} minutes: Performing a medically appropriate examination/evaluation and providing face-to-face counseling and educating the patient/caregiver regarding the treatment plan and medication side effects.`);
          if(b.orders) addLine(lines, `* ${b.orders} minutes: Ordering medications, tests, or procedures.`);
          if(b.doc) addLine(lines, `* ${b.doc} minutes: Documenting clinical information in the electronic health record.`);
          if(b.coord) addLine(lines, `* ${b.coord} minutes: Care coordination and communication with other health care professionals (when not separately reported).`);
        }
      } else {
        addLine(lines, "MDM and coding summary: " + signals.justification);
      }

      return lines.join("\n");
    }

    function render(){
      const signals = scoreMDM();
      const timeScore = scoreTime();

      let mappedCode = "99213";
      if(signals.mdm === "high") mappedCode = "99215";
      else if(signals.mdm === "moderate") mappedCode = "99214";
      else if(signals.mdm === "low") mappedCode = "99213";
      else if(signals.mdm === "minimal") mappedCode = "99212";

      let chosen = { basis: "mdm", code: mappedCode };

      if(useTimeWhenAvailable && timeScore){
        chosen = { basis: "time", code: timeScore.code, timeMinutes: Number(els.timeMinutes.value || 0), timeLabel: timeScore.label };
      }

      const code = chosen.code;
      els.suggestedCode.textContent = code;

      if(chosen.basis === "time"){
        els.badge.className = "badge good";
        els.badge.textContent = chosen.timeLabel;
        els.reasonText.textContent =
          "Suggested by total time. Keep documentation medically appropriate, then copy the note into the EHR.";
      } else {
        if(signals.mdm === "moderate"){
          els.badge.className = "badge good";
          els.badge.textContent = "Based on MDM: moderate";
          els.reasonText.textContent = signals.justification;
        } else if(signals.mdm === "low"){
          els.badge.className = "badge warn";
          els.badge.textContent = "Based on MDM: low";
          els.reasonText.textContent = signals.justification;
        } else {
          els.badge.className = "badge bad";
          els.badge.textContent = "Based on MDM: minimal";
          els.reasonText.textContent =
            signals.justification + " Add documentation for problems, data, and risk elements that are clinically true.";
        }
      }

      const note = buildNote(signals, chosen);
      els.notePreview.textContent = note;
      renderBreakdownStatus();
    }

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      setTimeout(()=> els.toast.classList.remove("show"), 1800);
    }

    function copyNote(){
      const txt = els.notePreview.textContent;
      navigator.clipboard.writeText(txt).then(()=>{
        toast("Note copied to clipboard.");
      }).catch(()=>{
        toast("Copy failed. Your browser may block clipboard access.");
      });
    }

    function clearTemplateSelection(){
      currentTemplate = null;
      els.tabs.forEach(t => {
        t.classList.remove("active");
        t.setAttribute("aria-selected", "false");
      });
      els.previewMeta.textContent = "Template: none";
    }

    function clearPatientInfo(){
      const checkboxes = Array.from(document.querySelectorAll("input[type=\"checkbox\"]"));
      checkboxes.forEach(field => { field.checked = false; });
      els.visitType.value = "";
      els.timeMinutes.value = 0;
      useTimeWhenAvailable = false;
      els.btnToggleTime.textContent = "Use time when available";
      clearTemplateSelection();
      render();
      toast("Patient info cleared.");
    }

    function applyTheme(theme){
      const nextTheme = theme === "light" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", nextTheme);
      localStorage.setItem("theme", nextTheme);
      els.btnTheme.textContent = nextTheme === "light" ? "Dark mode" : "Light mode";
      els.btnTheme.setAttribute("aria-pressed", nextTheme === "light" ? "true" : "false");
    }

    els.tabs.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setTemplate(btn.dataset.template);
      });
    });

    Object.values(checks).forEach(c => c.addEventListener("change", render));
    conditionChecks.forEach(c => c.addEventListener("change", render));
    probWorsening.addEventListener("change", render);
    els.visitType.addEventListener("change", render);
    els.timeMinutes.addEventListener("input", render);
    ["tPrep","tEvalCounsel","tOrders","tDoc","tCoord"].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.addEventListener("change", render);
    });

    els.btnCopyPreview.addEventListener("click", copyNote);
    els.btnClearPatient.addEventListener("click", clearPatientInfo);
    els.btnSuggestLow.addEventListener("click", setLowDefaults);
    els.btnSuggestMod.addEventListener("click", setModerateDefaults);

    els.btnTheme.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(current === "light" ? "dark" : "light");
      toast(current === "light" ? "Dark mode enabled." : "Light mode enabled.");
    });

    els.btnToggleTime.addEventListener("click", ()=>{
      useTimeWhenAvailable = !useTimeWhenAvailable;
      els.btnToggleTime.textContent = useTimeWhenAvailable ? "Time mode enabled" : "Use time when available";
      toast(useTimeWhenAvailable ? "Time mode enabled." : "Time mode disabled.");
      render();
    });

    initTimeBreakdowns();

    const storedTheme = localStorage.getItem("theme");
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    applyTheme(storedTheme || (prefersLight ? "light" : "dark"));

    setTemplate("adhd");
  </script>
</body>
</html>
